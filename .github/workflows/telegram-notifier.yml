name: Telegram Notifier Pro+
on:
  push:
    branches: ['**']
    tags: ['**']
    paths-ignore: 
      - 'docs/**'
      - 'README.md'
  pull_request:
    types: [opened, closed, reopened, ready_for_review, synchronize]
  issues:
    types: [opened, closed, reopened, labeled, assigned]
  workflow_run:
    workflows: ["CI", "Tests", "Security Scan"]
    types: [completed, requested]
  release:
    types: [published, edited]

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Send Smart Notification
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          ENVIRONMENT: ${{ github.event_name == 'release' && 'PROD' || 'DEV' }}
        run: |
          # Configuraci√≥n avanzada
          REPO_NAME="${{ github.repository }}"
          REPO_URL="${{ github.server_url }}/$REPO_NAME"
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          CURRENT_TIME=$(date +"%Y-%m-%d %H:%M:%S %Z")
          
          # Funci√≥n para escapar caracteres MarkdownV2
          escape_markdown() {
            echo "$1" | sed -e 's/[_\*\[\]()~`>#+\-=\|{}\.!]/\\&/g'
          }

          # Mensajes din√°micos con emojis contextuales
          case "${{ github.event_name }}" in
            "push")
              COMMIT_MSG=$(escape_markdown "${{ github.event.head_commit.message }}" | cut -c1-100)
              
              # Contar archivos modificados de forma robusta
              NUM_ADDED=$(echo "${{ github.event.head_commit.added }}" | wc -w || echo 0)
              NUM_MODIFIED=$(echo "${{ github.event.head_commit.modified }}" | wc -w || echo 0)
              NUM_CHANGES=$((NUM_ADDED + NUM_MODIFIED))
              
              if [ "$NUM_CHANGES" -gt 20 ]; then
                CHANGE_EMOJI="üì¶"
              elif [ "$NUM_CHANGES" -gt 5 ]; then
                CHANGE_EMOJI="üìÇ"
              else
                CHANGE_EMOJI="üìÑ"
              fi

              MESSAGE="üöÄ *Push en $(escape_markdown "$REPO_NAME")* ($REPO_URL) [${ENVIRONMENT}]
                      \n‚ñ´Ô∏è *Rama*: \`$(escape_markdown "${GITHUB_REF##*/}")\`
                      \n‚ñ´Ô∏è *Autor*: [@$(escape_markdown "${{ github.actor }}")]($REPO_URL/${{ github.actor }})
                      \n‚ñ´Ô∏è *Commit*: [\`$(escape_markdown "$SHORT_SHA")\`](${{ github.event.head_commit.url }}) - $(escape_markdown "$COMMIT_MSG")
                      \n${CHANGE_EMOJI} *Archivos modificados*: $NUM_CHANGES
                      \nüïí *Hora*: $(escape_markdown "$CURRENT_TIME")"
              ;;

            "pull_request")
              PR_ACTION="${{ github.event.action }}"
              case "$PR_ACTION" in
                "opened") EMOJI="üÜï";;
                "closed") 
                  if ${{ github.event.pull_request.merged }}; then EMOJI="‚úÖ MERGED"; else EMOJI="‚ùå CLOSED"; fi;;
                "reopened") EMOJI="üîÅ";;
                "ready_for_review") EMOJI="üëÄ";;
                "synchronize") EMOJI="üîÑ";;
                *) EMOJI="üîÄ";;
              esac
              
              REVIEWERS=$(echo "${{ github.event.pull_request.requested_reviewers.*.login }}" | tr ' ' '\n' | grep -v '^$' | tr '\n' ',' | sed 's/,$//')
              [ -z "$REVIEWERS" ] && REVIEWERS="ninguno"
              
              MESSAGE="$EMOJI *PR ${PR_ACTION^^}: [$(escape_markdown "${{ github.event.pull_request.title }}")](${{ github.event.pull_request.html_url }})*
                      \n‚ñ´Ô∏è *Por*: [@$(escape_markdown "${{ github.actor }}")]($REPO_URL/${{ github.actor }})
                      \n‚ñ´Ô∏è *Rama*: \`$(escape_markdown "${{ github.event.pull_request.head.ref }}") ‚Üí $(escape_markdown "${{ github.event.pull_request.base.ref }}")\`
                      \n‚ñ´Ô∏è *Estado*: ${{ github.event.pull_request.state }} | *Revisiones*: @$(escape_markdown "$REVIEWERS")
                      \nüìä *Cambios*: +${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }} (üîÑ ${{ github.event.pull_request.changed_files }} files)
                      \nüïí *Actualizado*: $(escape_markdown "$CURRENT_TIME")"
              ;;

            "issues")
              ISSUE_LABELS=$(echo "${{ github.event.issue.labels.*.name }}" | tr ' ' '\n' | grep -v '^$' | tr '\n' ',' | sed 's/,$//')
              ASSIGNEE="${{ github.event.issue.assignee.login }}"
              [ -z "$ASSIGNEE" ] && ASSIGNEE="sin asignar"
              
              case "${{ github.event.action }}" in
                "opened") ISSUE_EMOJI="‚ö†Ô∏è";;
                "closed") ISSUE_EMOJI="‚úÖ";;
                "reopened") ISSUE_EMOJI="üîÅ";;
                "labeled") ISSUE_EMOJI="üè∑Ô∏è";;
                "assigned") ISSUE_EMOJI="üë§";;
                *) ISSUE_EMOJI="‚ÑπÔ∏è";;
              esac
              
              MESSAGE="$ISSUE_EMOJI *Issue ${${{ github.event.action }}^^}: [$(escape_markdown "${{ github.event.issue.title }}")](${{ github.event.issue.html_url }})*
                      \n‚ñ´Ô∏è *Por*: [@$(escape_markdown "${{ github.event.issue.user.login }}")]($REPO_URL/${{ github.event.issue.user.login }})
                      \n‚ñ´Ô∏è *Asignado a*: [@$(escape_markdown "$ASSIGNEE")]($REPO_URL/$ASSIGNEE)
                      \nüè∑Ô∏è *Etiquetas*: $(escape_markdown "${ISSUE_LABELS:-ninguna}")
                      \n‚ñ´Ô∏è *Estado*: ${{ github.event.issue.state }} | üí¨ ${{ github.event.issue.comments }} comentarios
                      \nüïí *Actualizado*: $(escape_markdown "$CURRENT_TIME")"
              ;;

            "workflow_run")
              WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
              DURATION_SEC=${{ github.event.workflow_run.run_duration }}
              DURATION_STR=$(printf '%02d:%02d' $((DURATION_SEC/60)) $((DURATION_SEC%60)))
              
              case "${{ github.event.workflow_run.conclusion }}" in
                "success") EMOJI="‚úîÔ∏è"; STATUS="EXITOSO";;
                "failure") EMOJI="‚ùå"; STATUS="FALLIDO";;
                "cancelled") EMOJI="üõë"; STATUS="CANCELADO";;
                "skipped") EMOJI="‚è≠Ô∏è"; STATUS="OMITIDO";;
                *) EMOJI="‚ÑπÔ∏è"; STATUS="${{ github.event.workflow_run.conclusion }}";;
              esac
              
              MESSAGE="$EMOJI *Workflow [$(escape_markdown "$WORKFLOW_NAME")](${{ github.event.workflow_run.html_url }}) $STATUS*
                      \n‚ñ´Ô∏è *Duraci√≥n*: $(escape_markdown "$DURATION_STR")
                      \n‚ñ´Ô∏è *Commit*: [\`$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)\`]($REPO_URL/commit/${{ github.event.workflow_run.head_sha }})
                      \n‚ñ´Ô∏è *Trigger*: ${{ github.event.workflow_run.event }} | *Ejecutado por*: $(escape_markdown "${{ github.event.workflow_run.actor.login }}")
                      \nüïí *Finalizado*: $(escape_markdown "$CURRENT_TIME")"
              ;;
              
            "release")
              RELEASE_ACTION="${{ github.event.action }}"
              case "$RELEASE_ACTION" in
                "published") EMOJI="üéâ";;
                "edited") EMOJI="‚úèÔ∏è";;
                *) EMOJI="üìå";;
              esac
              
              MESSAGE="$EMOJI *Nuevo release [$(escape_markdown "${{ github.event.release.tag_name }}")](${{ github.event.release.html_url }})*
                      \nüìå *T√≠tulo*: $(escape_markdown "${{ github.event.release.name }}")
                      \nüìù *Descripci√≥n*: $(echo "${{ github.event.release.body }}" | head -n 3 | sed 's/\n/ /g' | escape_markdown)...
                      \nüè∑Ô∏è *Pre-release*: ${{ github.event.release.prerelease }} | *Draft*: ${{ github.event.release.draft }}
                      \nüïí *Publicado*: $(escape_markdown "$CURRENT_TIME")"
              ;;
          esac

          # Env√≠o mejorado con manejo de errores
          echo "Sending notification to Telegram..."
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="MarkdownV2" \
            -d disable_web_page_preview="true" \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" != "200" ]; then
            echo "::error::Failed to send Telegram notification. HTTP Code: $HTTP_CODE"
            echo "Response: $(echo "$RESPONSE" | head -n -1)"
            exit 1
          else
            echo "Notification sent successfully!"
          fi