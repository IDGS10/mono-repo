name: WhatsApp Notifier (All Branches) - Trial Friendly
on:
  push:
  pull_request:
    types: [opened, closed, reopened]
  issues:
    types: [opened, closed]

jobs:
  notify-group:
    runs-on: ubuntu-latest
    steps:
      - name: Send WhatsApp notification
        env:
          TWILIO_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          GROUP_ID: ${{ secrets.MY_PHONE }}  # Formato: whatsapp:1234567890@g.us
          FROM_PHONE: ${{ secrets.TWILIO_PHONE }}     # N√∫mero Twilio (ej: whatsapp:+14155238886)
        run: |
          # Formatea mensajes m√°s cortos para cuentas Trial
          case "${{ github.event_name }}" in
            "push")
              SHORT_HASH=$(echo "${{ github.sha }}" | cut -c1-7)
              COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1 | cut -c1-60)
              MESSAGE="üìå Commit en ${{ github.repository }} (${GITHUB_REF##*/})
                      $COMMIT_MSG...
                      üîó ${{ github.server_url }}/${{ github.repository }}/commit/$SHORT_HASH"
              ;;
            "pull_request")
              PR_TITLE=$(echo "${{ github.event.pull_request.title }}" | head -n 1 | cut -c1-40)
              MESSAGE="üîÄ PR ${{ github.event.action }}: $PR_TITLE...
                      üåø ${{ github.event.pull_request.head.ref }}
                      üîó ${{ github.event.pull_request.html_url }}"
              ;;
            "issues")
              ISSUE_TITLE=$(echo "${{ github.event.issue.title }}" | head -n 1 | cut -c1-40)
              MESSAGE="‚ö†Ô∏è Issue ${{ github.event.action }}: $ISSUE_TITLE...
                      üîó ${{ github.event.issue.html_url }}"
              ;;
          esac

          # Acortar a√∫n m√°s el mensaje si es necesario (m√°x 160 caracteres recomendado)
          SHORT_MESSAGE=$(echo "$MESSAGE" | tr -d '\n' | cut -c1-160)
          
          # Env√≠a el mensaje v√≠a Twilio
          curl -X POST "https://api.twilio.com/2010-04-01/Accounts/$TWILIO_SID/Messages.json" \
            --user "$TWILIO_SID:$TWILIO_TOKEN" \
            -d "Body=$SHORT_MESSAGE" \
            -d "From=$FROM_PHONE" \
            -d "To=$GROUP_ID"